# Azure Site Recovery - Ransomware Protection

**Author(s)**: Pradheep Myaka & Rajath Ranganath

**Contributor(s)**: Surya Sripathi Raju & Utsav Raghuvanshi

Azure Site Recovery (ASR) recovery plan is utilized to execute a script at the time of failover and to initiate Microsoft Defender on the failed over virtual machine.
Microsoft Defender then scans the new virtual machine, which is created as a result of the failover, to ensure that it is free of malware.
Using alerts generated by Microsoft Defender for Cloud, if any presence of malware is detected on the new virtual machine, this virtual machine is deleted, and another recovery point (which is older to the one that was initially selected for failing over) is automatically selected for the failover till no malware is detected on the failed over virtual machine.


**Scope:**

This solution is currently scoped to Virtual Machines, be it Azure to Azure (A2A) or VMWare to Azure (V2A).
The ARM template will create the Azure automation account. In order to be able to deploy the resources, Managed identity need so assign to the Automation account, needs to be granted owner rights on the Subscription.

**How it works**

**Pre-requisites:**

Enable Azure Site Recovery for Virtual Machines
https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview

Enable Microsoft Defender for Servers Plan 2 for the Subscription
https://learn.microsoft.com/en-us/azure/defender-for-cloud/enable-enhanced-security#enable-enhanced-security-features-on-a-subscription


For virtual machines protected using ASR, follow the steps mentioned below to recover your data from a recovery point which is free of malware.

1. Create a automation account using the template azuredeploy.json.
1. Post deployment of Automation account, Update the both the runbooks with the PowerShell scripts.
1. Update the Automation account variables with the Recovery service vault details.
1. Create the User identity or System identity and add the Identity to the automation account.
1. Provide the Subscription access to the Identity with the onwer rights.
1. Create a recovery plan in ASR, and add a post action that would define the above script to run on the machine after failover. Provide the SchedulerForRansomwareDetection runbook in ASR recovery plan.



Trigger the failover, which creates the failed over virtual machine in the secondary environment in Azure.  

The postscript runs automatically and sets up policies and configurations that install and set up Microsoft Defender on the new virtual machine. As part of the process, agents required for running Defender are also installed.  

Note: It is important to note that a key step of this process is to enable auto-provisioning of Defender, which enables Defender for all virtual machines in the subscription and scans them for malware.  

The scheduler script is used to monitor the alerts created by Defender on the failed over VM, so it keeps checking, so that appropriate action could be taken for mitigation. Hence, the script keeps checking the Microsoft Defender for Cloud portal for any alerts. 

 

If the new virtual machine is infected with malware, an alert is created by Defender. which is detected in the automation account. Details regarding the infection can be viewed in the ‘Jobs’ section. 

Post this, the script will start identifying the Replicated item for which this alert was raised. Change Recovery point is disable for now. We can enable in future to automatically perform a 'Change PIT' operation to failover to a previous recovery point that created before the one failed over to. This is by default this is 1 day old; however, you can configure it as per your needs. 

The newly created VM will once again be scanned and checked for any ransomware and the script will continue to iterate until we find a secure recovery point and create a ransomware free VM.  

 

 

**Additional Resources:**

What is Microsoft Defender for Cloud? - Microsoft Defender for Cloud | Microsoft Learn 

https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-cloud-introduction

Reference table for all security alerts in Microsoft Defender for Cloud | Microsoft Learn 

https://learn.microsoft.com/en-us/azure/defender-for-cloud/alerts-reference

How-to use Microsoft Defender for Cloud Ransomware alerts to preserve Azure Backup recovery points 

https://techcommunity.microsoft.com/t5/microsoft-defender-for-cloud/how-to-use-microsoft-defender-for-cloud-ransomware-alerts-to/ba-p/3693825

https://learn.microsoft.com/en-us/azure/backup/backup-azure-immutable-vault-concept 

https://learn.microsoft.com/en-us/azure/backup/backup-azure-immutable-vault-how-to-manage 

https://learn.microsoft.com/en-us/azure/backup/backup-azure-security-feature-cloud 

https://learn.microsoft.com/en-us/azure/backup/backup-azure-enhanced-soft-delete-about  